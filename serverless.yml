# Read the documentation at https://www.serverless.com/framework/docs/providers/aws/guide/serverless.yml/
service: feedbacks

provider:
  name: aws
  region: ${param:awsRegion}
  stage: ${param:appStage}
  runtime: provided.al2
  logRetentionInDays: 14
  httpApi:
    name: feedbacks-${self:provider.stage}-api
    metrics: true
    tags:
      Environment: ${param:tagEnvironment}
      Project: ${param:tagProject}
      Owner: ${param:tagOwner}
      Region: ${param:tagRegion}
  environment:
    APP_ENV: ${param:appEnv}
    APP_STAGE: ${param:appStage}
    APP_SECRET: ${param:appSecret}
    SITE_BASE_URL: ${param:siteBaseUrl}
    TELEGRAM_WEBHOOK_BASE_URL: ${param:telegramWebhookBaseUrl}
    TELEGRAM_ADMIN_ID: ${param:telegramAdminId}
    TELEGRAM_ACTIVITIES_TOKEN: ${param:telegramActivitiesToken}
    TELEGRAM_ERRORS_TOKEN: ${param:telegramErrorsToken}
    LOG_ACTIVITIES: ${param:logActivities}
    GOOGLE_API_KEY: ${param:googleApiKey}
    DB_URL: ${param:dbUrl}
    DYNAMODB_TABLE: ${param:dynamodbTable}
    DB_ENGINE: ${param:dbEngine}
    CRYPTO: ${param:crypto}
plugins:
  - ./vendor/bref/bref

functions:
  web:
    handler: public/index.php
    timeout: 28
    layers:
      - ${bref:layer.php-83-fpm}
    events:
      - httpApi: '*'
    role: WebRole
  console:
    handler: bin/console
    timeout: 240
    layers:
      - ${bref:layer.php-83}
      - ${bref:layer.console}
    role: ConsoleRole

package:
  patterns:
    - '!assets/**'
    - '!node_modules/**'
    - '!public/build/**'
    - '!tests/**'
    - '!var/**'
    - '!.idea/**'
    - '!.git/**'
    - '!.env.example'
    - '!.env'
    - '!.env.prod'
    - '!.phpunit.result.cache'
    - '!.editorconfig'
    - '!editconfig.xml'
    - '!phpunit.xml'
    - 'var/cache/prod/**'
    - 'public/build/entrypoints.json'
    - 'public/build/manifest.json'

resources:
  Resources:
    DynamoDBTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${param:dynamodbTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: pk
            AttributeType: S
          - AttributeName: sk
            AttributeType: S
          - AttributeName: telegram_bot_username_pk
            AttributeType: S
          - AttributeName: telegram_bot_pk
            AttributeType: S
          - AttributeName: telegram_bot_group_country_locale_sk
            AttributeType: S
          - AttributeName: telegram_channel_username_pk
            AttributeType: S
          - AttributeName: telegram_channel_pk
            AttributeType: S
          - AttributeName: telegram_channel_group_country_locale_sk
            AttributeType: S
          - AttributeName: level_1_region_pk
            AttributeType: S
          - AttributeName: level_1_region_country_code_name_sk
            AttributeType: S
          - AttributeName: messenger_user_messenger_identifier_pk
            AttributeType: S
          - AttributeName: messenger_user_messenger_username_pk
            AttributeType: S
          - AttributeName: messenger_user_user_pk
            AttributeType: S
          - AttributeName: feedback_user_subscription_messenger_user_id_pk
            AttributeType: S
          - AttributeName: feedback_user_subscription_user_id_pk
            AttributeType: S
          - AttributeName: search_term_feedback_normalized_text_pk
            AttributeType: S
          - AttributeName: search_term_feedback_created_at_sk
            AttributeType: S
          - AttributeName: search_term_feedback_search_normalized_text_pk
            AttributeType: S
          - AttributeName: search_term_feedback_search_created_at_sk
            AttributeType: S
          - AttributeName: search_term_feedback_lookup_normalized_text_pk
            AttributeType: S
          - AttributeName: search_term_feedback_lookup_created_at_sk
            AttributeType: S
          - AttributeName: telegram_bot_payment_method_telegram_bot_id_pk
            AttributeType: S
        KeySchema:
          - AttributeName: pk
            KeyType: HASH
          - AttributeName: sk
            KeyType: RANGE
        TimeToLiveSpecification:
          Enabled: true
          AttributeName: expire_at
        GlobalSecondaryIndexes:
          - IndexName: TELEGRAM_BOTS_BY_USERNAME
            KeySchema:
              - AttributeName: telegram_bot_username_pk
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: TELEGRAM_BOTS_BY_GROUP_COUNTRY_LOCALE
            KeySchema:
              - AttributeName: telegram_bot_pk
                KeyType: HASH
              - AttributeName: telegram_bot_group_country_locale_sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: TELEGRAM_CHANNELS_BY_USERNAME
            KeySchema:
              - AttributeName: telegram_channel_username_pk
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: TELEGRAM_CHANNELS_BY_GROUP_COUNTRY_LOCALE
            KeySchema:
              - AttributeName: telegram_channel_pk
                KeyType: HASH
              - AttributeName: telegram_channel_group_country_locale_sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: LEVEL_1_REGIONS_BY_COUNTRY_NAME
            KeySchema:
              - AttributeName: level_1_region_pk
                KeyType: HASH
              - AttributeName: level_1_region_country_code_name_sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: MESSENGER_USERS_BY_MESSENGER_IDENTIFIER
            KeySchema:
              - AttributeName: messenger_user_messenger_identifier_pk
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: MESSENGER_USERS_BY_MESSENGER_USERNAME
            KeySchema:
              - AttributeName: messenger_user_messenger_username_pk
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: MESSENGER_USERS_BY_USER
            KeySchema:
              - AttributeName: messenger_user_user_pk
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: FEEDBACK_USER_SUBSCRIPTIONS_BY_MESSENGER_USER
            KeySchema:
              - AttributeName: feedback_user_subscription_messenger_user_id_pk
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: FEEDBACK_USER_SUBSCRIPTIONS_BY_USER
            KeySchema:
              - AttributeName: feedback_user_subscription_user_id_pk
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: SEARCH_TERM_FEEDBACKS_BY_SEARCH_TERM_NORMALIZED_TEXT_CREATED
            KeySchema:
              - AttributeName: search_term_feedback_normalized_text_pk
                KeyType: HASH
              - AttributeName: search_term_feedback_created_at_sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: SEARCH_TERM_FEEDBACK_SEARCHES_BY_SEARCH_TERM_NORMALIZED_TEXT_CREATED
            KeySchema:
              - AttributeName: search_term_feedback_search_normalized_text_pk
                KeyType: HASH
              - AttributeName: search_term_feedback_search_created_at_sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: SEARCH_TERM_FEEDBACK_LOOKUPS_BY_SEARCH_TERM_NORMALIZED_TEXT_CREATED
            KeySchema:
              - AttributeName: search_term_feedback_lookup_normalized_text_pk
                KeyType: HASH
              - AttributeName: search_term_feedback_lookup_created_at_sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: TELEGRAM_BOT_PAYMENT_METHODS_BY_TELEGRAM_BOT
            KeySchema:
              - AttributeName: telegram_bot_payment_method_telegram_bot_id_pk
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        Tags:
          - Key: Environment
            Value: ${param:tagEnvironment}
          - Key: Project
            Value: ${param:tagProject}
          - Key: Owner
            Value: ${param:tagOwner}
          - Key: Region
            Value: ${param:tagRegion}

    WebRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: !Sub "${WebLambdaFunction}-role"
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal:
                Service: lambda.amazonaws.com
              Action: sts:AssumeRole
        Policies:
          - PolicyName: DynamoDB
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - dynamodb:PutItem
                    - dynamodb:GetItem
                    - dynamodb:BatchGetItem
                    - dynamodb:UpdateItem
                    - dynamodb:DeleteItem
                    - dynamodb:Query
                    - dynamodb:Scan
                  Resource:
                    - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${param:dynamodbTable}"
                    - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${param:dynamodbTable}/index/*"
          - PolicyName: Logs
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource: "*"
        Tags:
          - Key: Environment
            Value: ${param:tagEnvironment}
          - Key: Project
            Value: ${param:tagProject}
          - Key: Owner
            Value: ${param:tagOwner}
          - Key: Region
            Value: ${param:tagRegion}

    ConsoleRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: !Sub "${ConsoleLambdaFunction}-role"
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal:
                Service: lambda.amazonaws.com
              Action: sts:AssumeRole
        Policies:
          - PolicyName: DynamoDB
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - dynamodb:PutItem
                    - dynamodb:GetItem
                    - dynamodb:BatchGetItem
                    - dynamodb:UpdateItem
                    - dynamodb:DeleteItem
                    - dynamodb:Query
                    - dynamodb:Scan
                  Resource:
                    - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${param:dynamodbTable}"
                    - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${param:dynamodbTable}/index/*"
          - PolicyName: Logs
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource: "*"
        Tags:
          - Key: Environment
            Value: ${param:tagEnvironment}
          - Key: Project
            Value: ${param:tagProject}
          - Key: Owner
            Value: ${param:tagOwner}
          - Key: Region
            Value: ${param:tagRegion}

    WebLogGroup:
      Type: AWS::Logs::LogGroup
      DependsOn:
        - WebLambdaFunction
      Properties:
        LogGroupName: !Sub "/aws/lambda/${WebLambdaFunction}"
        RetentionInDays: 14
        Tags:
          - Key: Environment
            Value: ${param:tagEnvironment}
          - Key: Project
            Value: ${param:tagProject}
          - Key: Owner
            Value: ${param:tagOwner}
          - Key: Region
            Value: ${param:tagRegion}

    ConsoleLogGroup:
      Type: AWS::Logs::LogGroup
      DependsOn:
        - ConsoleLambdaFunction
      Properties:
        LogGroupName: !Sub "/aws/lambda/${ConsoleLambdaFunction}"
        RetentionInDays: 14
        Tags:
          - Key: Environment
            Value: ${param:tagEnvironment}
          - Key: Project
            Value: ${param:tagProject}
          - Key: Owner
            Value: ${param:tagOwner}
          - Key: Region
            Value: ${param:tagRegion}