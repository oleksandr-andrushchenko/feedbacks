# Read the documentation at https://www.serverless.com/framework/docs/providers/aws/guide/serverless.yml/
service: ${env:AWS_PROJECT}

provider:
  name: aws
  runtime: provided.al2
  logRetentionInDays: 14
  httpApi:
    name: ${env:AWS_PROJECT}-${sls:stage}-api
    metrics: true
  environment:
    APP_STAGE: ${sls:stage}
    APP_ENV: ${env:APP_ENV}
    APP_DEBUG: ${env:APP_DEBUG}
    APP_SECRET: ${ssm:/${env:AWS_PROJECT}/${sls:stage}/APP_SECRET}
    SITE_BASE_URL: ${ssm:/${env:AWS_PROJECT}/${sls:stage}/SITE_BASE_URL}
    TELEGRAM_WEBHOOK_BASE_URL: ${ssm:/${env:AWS_PROJECT}/${sls:stage}/TELEGRAM_WEBHOOK_BASE_URL}
    TELEGRAM_ADMIN_ID: ${env:TELEGRAM_ADMIN_ID}
    TELEGRAM_ACTIVITIES_TOKEN: ${ssm:/${env:AWS_PROJECT}/${sls:stage}/TELEGRAM_ACTIVITIES_TOKEN}
    TELEGRAM_ERRORS_TOKEN: ${ssm:/${env:AWS_PROJECT}/${sls:stage}/TELEGRAM_ERRORS_TOKEN}
    GOOGLE_API_KEY: ${ssm:/${env:AWS_PROJECT}/${sls:stage}/GOOGLE_API_KEY}
    DB_URL: ${ssm:/${env:AWS_PROJECT}/${sls:stage}/DB_URL}
    DYNAMODB_TABLE: ${env:DYNAMODB_TABLE}
    DB_ENGINE: ${env:DB_ENGINE}
    CRYPTO: ${ssm:/${env:AWS_PROJECT}/${sls:stage}/CRYPTO}
  tags:
    Stage: ${sls:stage}
    Project: ${env:AWS_PROJECT}
    Owner: ${env:AWS_OWNER}
    Region: ${aws:region}

plugins:
  - ./vendor/bref/bref
  - serverless-dotenv-plugin

custom:
  dotenv:
    path: .env
    include: [ ]

functions:
  web:
    handler: public/index.php
    timeout: 28
    layers:
      - ${bref:layer.php-83-fpm}
    events:
      - httpApi: '*'
    role: WebRole
  console:
    handler: bin/console
    timeout: 240
    layers:
      - ${bref:layer.php-83}
      - ${bref:layer.console}
    role: ConsoleRole

package:
  patterns:
    - '!assets/**'
    - '!node_modules/**'
    - '!public/build/**'
    - '!tests/**'
    - '!var/**'
    - '!.idea/**'
    - '!.git/**'
    - '!.env.example'
    - '!.env'
    - '!package-lock.json'
    - '!package.json'
    - '!Makefile'
    - '!.phpunit.result.cache'
    - '!.editorconfig'
    - '!editconfig.xml'
    - '!phpunit.xml'
    - 'var/cache/prod/**'
    - 'public/build/entrypoints.json'
    - 'public/build/manifest.json'

resources:
  Resources:
    DynamoDBTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${env:DYNAMODB_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: pk
            AttributeType: S
          - AttributeName: sk
            AttributeType: S
          - AttributeName: telegram_bot_username_pk
            AttributeType: S
          - AttributeName: telegram_bot_pk
            AttributeType: S
          - AttributeName: telegram_bot_group_country_locale_sk
            AttributeType: S
          - AttributeName: telegram_channel_username_pk
            AttributeType: S
          - AttributeName: telegram_channel_pk
            AttributeType: S
          - AttributeName: telegram_channel_group_country_locale_sk
            AttributeType: S
          - AttributeName: level_1_region_pk
            AttributeType: S
          - AttributeName: level_1_region_country_code_name_sk
            AttributeType: S
          - AttributeName: messenger_user_messenger_identifier_pk
            AttributeType: S
          - AttributeName: messenger_user_messenger_username_pk
            AttributeType: S
          - AttributeName: messenger_user_user_pk
            AttributeType: S
          - AttributeName: feedback_user_subscription_messenger_user_id_pk
            AttributeType: S
          - AttributeName: feedback_user_subscription_user_id_pk
            AttributeType: S
          - AttributeName: search_term_feedback_normalized_text_pk
            AttributeType: S
          - AttributeName: search_term_feedback_created_at_sk
            AttributeType: S
          - AttributeName: search_term_feedback_search_normalized_text_pk
            AttributeType: S
          - AttributeName: search_term_feedback_search_created_at_sk
            AttributeType: S
          - AttributeName: search_term_feedback_lookup_normalized_text_pk
            AttributeType: S
          - AttributeName: search_term_feedback_lookup_created_at_sk
            AttributeType: S
          - AttributeName: telegram_bot_payment_method_telegram_bot_id_pk
            AttributeType: S
        KeySchema:
          - AttributeName: pk
            KeyType: HASH
          - AttributeName: sk
            KeyType: RANGE
        TimeToLiveSpecification:
          Enabled: true
          AttributeName: expire_at
        GlobalSecondaryIndexes:
          - IndexName: TELEGRAM_BOTS_BY_USERNAME
            KeySchema:
              - AttributeName: telegram_bot_username_pk
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: TELEGRAM_BOTS_BY_GROUP_COUNTRY_LOCALE
            KeySchema:
              - AttributeName: telegram_bot_pk
                KeyType: HASH
              - AttributeName: telegram_bot_group_country_locale_sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: TELEGRAM_CHANNELS_BY_USERNAME
            KeySchema:
              - AttributeName: telegram_channel_username_pk
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: TELEGRAM_CHANNELS_BY_GROUP_COUNTRY_LOCALE
            KeySchema:
              - AttributeName: telegram_channel_pk
                KeyType: HASH
              - AttributeName: telegram_channel_group_country_locale_sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: LEVEL_1_REGIONS_BY_COUNTRY_NAME
            KeySchema:
              - AttributeName: level_1_region_pk
                KeyType: HASH
              - AttributeName: level_1_region_country_code_name_sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: MESSENGER_USERS_BY_MESSENGER_IDENTIFIER
            KeySchema:
              - AttributeName: messenger_user_messenger_identifier_pk
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: MESSENGER_USERS_BY_MESSENGER_USERNAME
            KeySchema:
              - AttributeName: messenger_user_messenger_username_pk
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: MESSENGER_USERS_BY_USER
            KeySchema:
              - AttributeName: messenger_user_user_pk
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: FEEDBACK_USER_SUBSCRIPTIONS_BY_MESSENGER_USER
            KeySchema:
              - AttributeName: feedback_user_subscription_messenger_user_id_pk
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: FEEDBACK_USER_SUBSCRIPTIONS_BY_USER
            KeySchema:
              - AttributeName: feedback_user_subscription_user_id_pk
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: SEARCH_TERM_FEEDBACKS_BY_SEARCH_TERM_NORMALIZED_TEXT_CREATED
            KeySchema:
              - AttributeName: search_term_feedback_normalized_text_pk
                KeyType: HASH
              - AttributeName: search_term_feedback_created_at_sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: SEARCH_TERM_FEEDBACK_SEARCHES_BY_SEARCH_TERM_NORMALIZED_TEXT_CREATED
            KeySchema:
              - AttributeName: search_term_feedback_search_normalized_text_pk
                KeyType: HASH
              - AttributeName: search_term_feedback_search_created_at_sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: SEARCH_TERM_FEEDBACK_LOOKUPS_BY_SEARCH_TERM_NORMALIZED_TEXT_CREATED
            KeySchema:
              - AttributeName: search_term_feedback_lookup_normalized_text_pk
                KeyType: HASH
              - AttributeName: search_term_feedback_lookup_created_at_sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: TELEGRAM_BOT_PAYMENT_METHODS_BY_TELEGRAM_BOT
            KeySchema:
              - AttributeName: telegram_bot_payment_method_telegram_bot_id_pk
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        Tags:
          - Key: Stage
            Value: ${sls:stage}
          - Key: Project
            Value: ${env:AWS_PROJECT}
          - Key: Owner
            Value: ${env:AWS_OWNER}
          - Key: Region
            Value: ${aws:region}

    WebRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: ${env:AWS_PROJECT}-${sls:stage}-web-role
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal:
                Service: lambda.amazonaws.com
              Action: sts:AssumeRole
        Policies:
          - PolicyName: Parameters
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - ssm:GetParameter
                    - ssm:GetParameters
                  Resource:
                    - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${env:AWS_PROJECT}/${sls:stage}/*"
          - PolicyName: DynamoDB
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - dynamodb:PutItem
                    - dynamodb:GetItem
                    - dynamodb:BatchGetItem
                    - dynamodb:BatchWriteItem
                    - dynamodb:UpdateItem
                    - dynamodb:DeleteItem
                    - dynamodb:Query
                    - dynamodb:Scan
                  Resource:
                    - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${env:DYNAMODB_TABLE}"
                    - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${env:DYNAMODB_TABLE}/index/*"
          - PolicyName: Logs
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource: "*"
        Tags:
          - Key: Stage
            Value: ${sls:stage}
          - Key: Project
            Value: ${env:AWS_PROJECT}
          - Key: Owner
            Value: ${env:AWS_OWNER}
          - Key: Region
            Value: ${aws:region}

    ConsoleRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: ${env:AWS_PROJECT}-${sls:stage}-console-role
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal:
                Service: lambda.amazonaws.com
              Action: sts:AssumeRole
        Policies:
          - PolicyName: Parameters
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - ssm:GetParameter
                    - ssm:GetParameters
                  Resource:
                    - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${env:AWS_PROJECT}/${sls:stage}/*"
          - PolicyName: DynamoDB
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - dynamodb:PutItem
                    - dynamodb:GetItem
                    - dynamodb:BatchGetItem
                    - dynamodb:BatchWriteItem
                    - dynamodb:UpdateItem
                    - dynamodb:DeleteItem
                    - dynamodb:Query
                    - dynamodb:Scan
                  Resource:
                    - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${env:DYNAMODB_TABLE}"
                    - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${env:DYNAMODB_TABLE}/index/*"
          - PolicyName: Logs
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource: "*"
        Tags:
          - Key: Stage
            Value: ${sls:stage}
          - Key: Project
            Value: ${env:AWS_PROJECT}
          - Key: Owner
            Value: ${env:AWS_OWNER}
          - Key: Region
            Value: ${aws:region}

    WebLogGroup:
      Type: AWS::Logs::LogGroup
      Properties:
        LogGroupName: !Sub "/aws/lambda/${self:service}-${sls:stage}-web"
        RetentionInDays: 14
        Tags:
          - Key: Stage
            Value: ${sls:stage}
          - Key: Project
            Value: ${env:AWS_PROJECT}
          - Key: Owner
            Value: ${env:AWS_OWNER}
          - Key: Region
            Value: ${aws:region}

    ConsoleLogGroup:
      Type: AWS::Logs::LogGroup
      Properties:
        LogGroupName: !Sub "/aws/lambda/${self:service}-${sls:stage}-console"
        RetentionInDays: 14
        Tags:
          - Key: Stage
            Value: ${sls:stage}
          - Key: Project
            Value: ${env:AWS_PROJECT}
          - Key: Owner
            Value: ${env:AWS_OWNER}
          - Key: Region
            Value: ${aws:region}